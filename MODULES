$RuOBSD: MODULES,v 1.3 2004/05/09 19:38:49 shadow Exp $
Partially updated: 5.04.2005

            МОДУЛИ                  

path - сore  
bin  - /usr/local/bin/bee

     Ядро билинга. 

     Может быть запущен в двух режимах

   * Режим демона (ключ -d) Ядро запускается как tcp-сервер
      (по умолчанию на порте 49160), в ожидании соединений.
      При нормальной работе должна быть запущена одна
      инстанция ядра в режиме демона (чтобы принимать
      соединиения от счетчиков). 

   * Консольный режим (ключ -c) - однопользовательская консоль
      билинга на stdin/stdout. Перенаправленим ввода/вывода можно
      получить подобие скриптов.

   Если не указать ни одного из ключей, программа не войдет в
   основной цикл (т.е. выполнение команд), но выполнит все
   предварительные операции.

     Одновременно может быть запущено несколько инстанций программы.
   Для нормальной работы, одна инстанция должна работать в режиме
   демона.

        Usage:  bee [options]

 A    - TCP-порт (default - 49160). Имеет смысл только для режима демона
 u    - Обновить разрешения ПЕРЕД стартом основного цикла
 d    - запуститься в режиме демона 
 c    - запуститься в консольном режиме
 h, ? - помощь (не реализовано)

path - modules/traff
bin  - /usr/local/bin/beetraff

     Счетчик трафика. Клиент билинга.

     Не считает трафик самостоятельно, а парсит вывод
   программы dumpstat (ожидая его на stdin). Вывод dumstat - 
   (с модификатором "stat") cisco-like статистика по пакетам,
   направленным в pflog0 (log в привиле pf). dumpstat требует
   запущеного демона ipstatd (ставится дополнительно).
   Программа соединяется с билингом и передает ему подсчеты
   (командами res). Когда статистика заканчивается, на билинг
   отдается команда update (обновление правил) если указан
   ключ -u.

     Usage: dumpstat stat | beecisco [<switches>]
            dumpstat stat > tempfile && beecisco [switches] -f tempfile

 r - имя ресурса            (default - inet)
 a - хост билинга           (default - 127.0.0.1)
 A - порт билинга           (default прописан в ipc.h)
 u - дать команду update    (default - no)
 n - включить хост в список локальных
 N - исключить хост из списка локальных
 f - имя файла статистики   (default - stdin)

path   - modules/scripts
script - /usr/local/bin/beetraff-ipstatd.sh

     Скрипт-оболочка счетчика трафика.
   Cюда же рекомендуется добавить вызов счетчиков других ресурсов,
   базирующихся на трафике (причем последний с ключом -u).

   Прописывается в crontab.

script - /usr/local/bin/beepfrules.sh

     Скрипт-оболочка генератора правил beeipf (стал использоваться для pf)

     Прописан в строку генератора правил для ресурса inet.

script - /usr/local/bin/beeapply.sh

     Cкрипт, для активации правил для всех ресурсов.

script - /usr/local/sbin/intractl.sh

     Скрипт управления ресурсом intra (включение и выключение портов
   на свитче). Намеренно вынесен из общей процедуры обновления
   ресурсов вызвывается командой intractl билинга и/или из cron(8).
     Использует файл конфигурации /etc/bee/intra.conf (SNMP-описание
   устройств).
     Для SNMP использует пакет ucd-snmp-4.2.

script - /usr/local/bin/newlogin.sh

     (скрипт для макрокоманды new_name)

     Запускает скрипт autoreg.sh на удаленном хосте.

script - /usr/local/sbin/autoreg.sh

     (скрипт для макрокоманды new_name)

     Скрипт автоматической регистрации пользователя (имя пользователя
    передается в командной строке)
       >> добавляет группу
       >> генерирует случайный пароль 
       >> регистрирует учетную запись
       >> прописывает пользователя в chrootftp
       >> настраивает дисковые квоты (до 3.1 может вызывать крах системы)
       >> Возвращает пароль или сообшение об ошибке

path - rulers/traff
bin  - /usr/local/bin/beeipf

     Генератор правил ipf/pf.

     Строка для запуска (прямо или через скрипт) определяется в описателе
   ресурса. 

      Usage: beeipf [<switches>]

s - filter source file (default - /etc/ipf.rules)
t - filter target file (default - /var/bee/ipf.rules.effecive)
d - destination host   (default - "any")
i - target interface   (default - none)
r - resource name      (default - inet)
f - hostlist filename  (default - /var/bee/allowed.inet)
P - destination suffix (default - "")
p - source suffix      (default - "")
m - filter file mark   (default - "#<beerules>")
S - rule suffix        (default - "")
R - swap in & out      (default - no swap)
l - word before "on"   (default - "")
o - only one rule      (default - two rules)

path - utils/acc_on
bin  - /usr/local/bin/acc_on

     Включить аккаунт (аргумент). Для вебформы.
     
path - utils/acc_off
bin  - /usr/local/bin/acc_off

     Выключить аккаунт (аргумент). Для вебформы.

path - utils/ip2acc
bin  - /usr/local/bin/ip2acc

     Преобразовать ip в номер аккаунта.

path - utils/getacc
bin  - /usr/local/bin/getacc

     Программа для упрощенной PHP-веб формы (программа выводит
   отформатированный сегмент веб-страницы) просмотра пользователем
   состояния своего счета. Параметром ей передается ip адрес клиента,
   Резюме состояния счета выводится на stdout.

path - utils/getacc2
bin  - /usr/local/bin/getacc2

     Программа для сложной PHP-веб формы (выводятся несколько чисел - 
   параметры счета, под парсинг скриптом, генерация HTML-кода ложится на
   PHP-скрипт) просмотра пользователем состояния своего счета. Параметром
   ей передается ip адрес клиента. Резюме состояния счета выводится на
   stdout.

path - utils/beerep
bin  - /usr/local/bin/beerep

     Программа генерации HTML-отчета. Программа самостоятельно обращается
   к таблице лога транзакций и выбирает подходящие записи. Номера счетов
   либо задаются ключами -a, либо вводятся с stdin (<Номер>:<Описание>
   на каждой строке до EOF). Страница отчета выводится
   на stdout

   switches:

  F D:M:Y[:H] - начало периода
  T D:M:Y[:H] - конец периода (не включая указанный день/час !)
  a N         - номер аккаунта (можно указывать несколько таких ключей)
  r N         - ид ресурса (0 - inet, 2 - adder и т.п.)
  g           - группировать статистику (а не выводить по часам)
  s           - выдать итоговую сумму по всем аккаунтам
  h           - не показывать заголовков
  A           - считать трафик по всем аккаунтам
  i           - не считать входяший трафик
  o           - не считать исходящий трафик
  t <строка>  - задать последовательность полей в таблице
       D - дата
       T - время
       A - номер аккаунта
       B - итоговый балланс
       R - ресурс
       С - счетчик
       S - сумма транзакции
       E - результат тразакции
       I - направление (входящий/исходящий)
       H - хост клиента

path - utils/clubctl
bin  - /usr/local/sbin/clubctl

     Q&D решение урезанной консоли билинга (для управления доступом в инет
   с нескольких рабочих станций). Устанавливается в качестве пользовательского
   шелла.

path - utils/proxy

     Отладочная исследовательская утилита (журналирующий TCP-прокси).

